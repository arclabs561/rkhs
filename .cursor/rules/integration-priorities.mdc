---
title: "Integration Priorities"
id: integration-priorities
description: "Guidelines for how Tekne repositories interact and point to canonical overview"
globs: ["Cargo.toml", "evals/arch/dev_repos_overview.html", "evals/arch/**/*.html", "docs/**/*.md", "README.md"]
alwaysApply: true
---

# Integration Priorities: What Actually Matters

## Canonical integration view (single HTML artifact)

**Canonical file**: `evals/arch/dev_repos_overview.html`

**Rule**: If you need to understand or explain how repos interact, update that one HTML page instead of creating a new report page.

**It should contain**:
- **Levels (L0–L6)**: group repos by the Tekne stack layers (conceptual).
- **Repo-level graph**: integration edges (git deps, `[patch]` overrides, and the local “super-workspace”).
- **Crate-level graph**: the dev workspace view (“what Cargo sees”) plus a small conceptual edge set, and a mismatch table.
- **Tekne facade table**: feature ↔ crate mapping.
- **Recent activity + size**: the few biggest disk drivers + a short “what changed recently” list.
- **Axes view**: call out which repos are Tekne (L0–L6) vs Agents (A0–A3) vs Governance (G0–G5), since these are different partial orders.

**Links**:
- `tekne-core.mdc` defines the *meaning* of levels (L0–L6).
- `tekne-module-taxonomy.mdc` assesses doc quality by module; it is not a dependency graph.

## The Ecosystem at a Glance

```
PRODUCTION SCALE                        MATH PRIMITIVES
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
anno      371.3K LOC  7531 tests        equi          17 LOC     0 tests
cerno      90.5K LOC  2627 tests        fynch       1.5K LOC    53 tests
hop       117.8K LOC  2410 tests        walk         234 LOC     0 tests
innr        4.5K LOC   153 tests        helm          21 LOC     0 tests
jin        29.8K LOC   367 tests        hyp           2K LOC    51 tests
subsume    14.5K LOC   282 tests        kuji         738 LOC    15 tests
tier        4.7K LOC    76 tests        lapl         968 LOC    13 tests
webs       13.9K LOC   253 tests        law           38 LOC     0 tests
weigh          4 LOC     0 tests        liga          12 LOC     0 tests
                                        logp         567 LOC    10 tests
                                        pare         403 LOC     3 tests
                                        propago     4.7K LOC     0 tests
                                        qig          148 LOC     4 tests
                                        ritu          49 LOC     0 tests
                                        rkhs        1.3K LOC    23 tests
                                        rmt          230 LOC     7 tests
                                        textprep     197 LOC     3 tests
                                        sbits        736 LOC     8 tests
                                        sign          15 LOC     0 tests
                                        slabs       2.3K LOC    82 tests
                                        telic         31 LOC     0 tests
                                        wass         691 LOC    13 tests
```

## The Real Problems

### Problem 1: Differentiable ranking should stay centralized
`fynch` is the single canonical crate for differentiable sort/rank/top-k.

### Problem 2: fynch/metrics vs cerno-eval Overlap
Keep **core rank-based** metrics in one place (e.g. `fynch::metrics`), and keep domain adapters (IR / KGE / NED) in their domain crates.

### Problem 3: New Math Crates Are Islands
The “islands” problem is missing usage/tests, not missing dependency edges. Ensure integration tests verify that combining components improves outcomes versus using them individually.

### Problem 4: Hypha integration
`hypha` provides the P2P substrate. `bop` (Agents) should eventually run *over* `hypha` for distributed coordination. `hypha-knowledge` should leverage `jin` (L3) for vector storage to avoid duplication. `recal` provides the agent's long-term memory via FTS5/vector retrieval.

### Problem 5: Graph Layer Split
Keep `lattix` as the low-level graph core (L3/L4) and `webs` as the high-level knowledge graph layer (L5). `webs` consumes `lattix` types.

### Problem 6: Cross-axis coupling creep
The most common structural regression is accidental coupling where:
- Tekne crates start depending on Agents or Governance crates, making the substrate “application-shaped”
- Governance becomes a compile-time cross-cutting dependency instead of a gate/eval layer

Prefer governance as *inputs/outputs* (policy decisions, eval reports) over ubiquitous imports.

### Problem 7: Sparse lexical retrieval has no clear “low-level home”
Right now, **BM25/TF‑IDF + (learned) sparse retrieval** lives in `cerno-retrieve` (L5 Domain), but the underlying **inverted-index engine** shape belongs lower:

- **L1/L1.5**: scoring math + tokenization/normalization (`textprep`)
- **L3**: inverted index / segments / deletes / compaction / persistence format
- **L5**: pipelines (BM25 → rerank), hybrid orchestration, adapters

For a publishable, reusable L3 “sparse index” crate, borrow the *constraints-first* boundary from BurntSushi’s Nakala plan:
- keep tokenization pluggable (don’t bake in language-specific processing)
- keep query model small (boolean term queries are enough to start)
- avoid “fields/schema” early (multi-set of terms is the core)
- index-only (don’t store document content)
- handle deletes + segment merges as owned complexity

Also keep the candidate-generation contract explicit:
- **No false negatives** for the index/planner path: it may return false positives, but must not exclude a true match.
- **Planner bailouts are required**: if the query is too broad, it must be legal to fall back to exhaustive scanning.

Evidence/anchors:
- ripgrep indexing RFC (`BurntSushi/ripgrep#1497`) and implementation discussion (`BurntSushi/ripgrep#1518`) are a concrete example of these constraints applied to regex candidate generation (n-gram index + verification).
- Russ Cox’s trigram-index writeup is the canonical mental model for regex → boolean n-gram query → postings → verify.

Reference: `https://raw.githubusercontent.com/BurntSushi/nakala/master/doc/PLAN.md`
